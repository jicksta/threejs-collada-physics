<html>
<head>
  <script src="./lib/Three.js"></script>
  <script src="./lib/Stats.js"></script>
  <script src="./lib/physi.js"></script>
  <script src="./lib/physijs_worker.js"></script>
  <script>
    Physijs.scripts.worker = 'lib/physijs_worker.js';
    Physijs.scripts.ammo = 'ammo.js';
  </script>
</head>
<body>
<div id="container"/>
<script>
  var WIDTH = document.body.clientWidth, HEIGHT = document.body.clientHeight;

  var domElement = document.getElementById("container");
  var clock = new THREE.Clock;

  var scene = createScene();
  var camera = createCamera();
  var firstPersonControls = createControls();

  setupLighting();
  setupPhysics();

  var renderer = createRenderer();

//  loadCollada("box.dae", render);
  loadCollada("box.dae", render);

  function render() {
    requestAnimationFrame(render);
    scene.simulate(undefined, 2);
    firstPersonControls.update(clock.getDelta());
    renderer.render(scene, camera);
  }

  function createScene() {
    return new Physijs.Scene;
  }

  function createCamera() {
    var camera = new THREE.PerspectiveCamera(camera, WIDTH / HEIGHT, 1, 20000);
    camera.position.set(-4, 1, 0);
    scene.add(camera);
    return camera;
  }

  function createControls() {
    var controls = new THREE.FirstPersonControls(camera);
    controls.movementSpeed = 50;
    controls.lookSpeed = 0.125;
    return controls;
  }

  function setupPhysics() {
    scene.setGravity({x: 0, y: -10, z: 0});
    createCube();
  }

  function setupLighting() {
    var light = new THREE.PointLight(0x0020BB, 10, 50);
    light.position.set(5, 5, 5);
    scene.add(light);
  }

  function createCube() {
    var cube = new Physijs.BoxMesh(
        new THREE.CubeGeometry(1, 1, 1),
        new THREE.MeshLambertMaterial({color: 0xFFFFFF})
    );
    cube.position.y = 1;
    scene.add(cube);
  }

  function createRenderer() {
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(WIDTH, HEIGHT);
    domElement.appendChild(renderer.domElement);
    return renderer;
  }

  function loadCollada(file, callback) {
    var loader = new THREE.ColladaLoader();
    loader.options.convertUpAxis = true;
    loader.load(file, function(collada) {
      var material = new THREE.MeshLambertMaterial({color: "0x0000FF"});
      recursivelyImportMeshes(collada.scene);
      function recursivelyImportMeshes(obj) {
        if("geometry" in obj) {
          var mesh = new Physijs.CustomMesh(obj.geometry, material, 0);
          mesh.scale.x = mesh.scale.y = mesh.scale.z = 0.02;
          mesh.updateMatrix();
          scene.add(mesh);
        }
        obj.children.forEach(recursivelyImportMeshes);
      }

      callback();
    });
  }

</script>
</body>
</html>
