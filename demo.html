<html>
<head>
  <script src="./lib/Three.js"></script>
  <script src="./lib/Stats.js"></script>
</head>
<body>
<div id="container"/>
<script>
  var WIDTH = document.body.clientWidth, HEIGHT = document.body.clientHeight;

  var domElement = document.getElementById("container");
  var clock = new THREE.Clock;

  var scene = createScene();
  var camera = createCamera();
  var firstPersonControls = createControls();

  setupLighting();
  setupPhysics();

  var renderer = createRenderer();

//  loadCollada("models/box.dae", 0.02, render);
//  loadCollada("models/box-shaped.dae", 0.02, render);
//  loadCollada("models/many-meshes.dae", 0.02 render);
//  loadCollada("models/box.dae", 0.02, render);
  loadCollada("models/building.dae", 0.002, render);

  function render() {
    requestAnimationFrame(render);
    // TODO: Advance time
    firstPersonControls.update(clock.getDelta());
    renderer.render(scene, camera);
  }

  function createScene() {
    return new THREE.Scene;
  }

  function createCamera() {
    var camera = new THREE.PerspectiveCamera(camera, WIDTH / HEIGHT, 1, 20000);
    camera.position.set(-4, 1, 0);
    scene.add(camera);
    return camera;
  }

  function createControls() {
    var controls = new THREE.FirstPersonControls(camera);
    controls.movementSpeed = 30;
    controls.lookSpeed = 0.125;
    return controls;
  }

  function setupPhysics() {
    // TODO: Setup gravity
    createCube();
  }

  function setupLighting() {
    var light = new THREE.PointLight(0x0020BB, 10, 50);
    light.position.set(5, 5, 5);
    scene.add(light);
  }

  function createCube() {
    var cube = new THREE.Mesh(
        new THREE.CubeGeometry(1, 1, 1),
        new THREE.MeshLambertMaterial({color: 0xFFFFFF})
    );
    cube.position.y = 1.5;
    scene.add(cube);
  }

  function createRenderer() {
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(WIDTH, HEIGHT);
    domElement.appendChild(renderer.domElement);
    return renderer;
  }

  function loadCollada(file, scale, callback) {
    var loader = new THREE.ColladaLoader();
    loader.options.convertUpAxis = true;
    loader.load(file, function(collada) {
      var material = new THREE.MeshLambertMaterial({color: "0x0000FF"});
      recursivelyImportMeshes(collada.scene);

      function recursivelyImportMeshes(obj) {
        if("geometry" in obj) {
          var geometry = obj.geometry;
          obj.geometry.vertices.forEach(function (vert) {
            vert.position.x *= scale;
            vert.position.y *= scale;
            vert.position.z *= scale;
          });
          var mesh = new THREE.Mesh(geometry, material);
          // TODO: Set mass
          scene.add(mesh);
        }
        obj.children.forEach(recursivelyImportMeshes);
      }

      callback();
    });
  }

</script>
</body>
</html>
